package main

import (
	"context"
	"errors"
	"fmt"
	"github.com/CAFxX/httpcompression"
	"github.com/jessevdk/go-flags"
	"log"
	"math/rand"
	"net/http"
	"net/http/httputil"
	"net/url"
	"os"
	"os/signal"
	"path"
	"regexp"
	"strings"
	"tailscale.com/tsnet"
)

type Options struct {
	Address  string `required:"true" long:"address" env:"TS_SERVE_ADDRESS" description:"Address to serve"`
	Hostname string `long:"hostname" env:"TS_SERVE_HOSTNAME" description:"Hostname to become"`
	AuthKey  string `required:"true" long:"auth-key" env:"TS_SERVE_AUTHKEY" description:"Tailscale authentication key"`
	StateDir string `long:"state-dir" env:"TS_SERVE_STATE" description:"Tailscale state directory"`
}

var options Options

var parser = flags.NewParser(&options, flags.Default)

func main() {
	ctx, stop := signal.NotifyContext(context.Background(), os.Interrupt)
	defer stop()
	if err := run(ctx); err != nil {
		log.Fatal(err)
	}
}

func run(ctx context.Context) error {
	if _, err := parser.Parse(); err != nil {
		return err
	}
	if options.StateDir == "" {
		tmpdir, err := os.MkdirTemp("", "ts-serve-state")
		if err != nil {
			return err
		}
		options.StateDir = tmpdir
		defer os.RemoveAll(tmpdir)
	} else {
		if err := os.Mkdir(options.StateDir, 0700); err != nil && !errors.Is(err, os.ErrExist) {
			return err
		}
	}

	if options.Hostname == "" {
		hostnameFile := path.Join(options.StateDir, "hostname")
		if hostnameData, err := os.ReadFile(hostnameFile); err != nil {
			if errors.Is(err, os.ErrNotExist) {
				options.Hostname = generateXkcdPw()
			} else {
				return err
			}
		} else {
			options.Hostname = string(hostnameData[:])
		}
		os.WriteFile(hostnameFile, []byte(options.Hostname), 0755)
	}

	if matched, err := regexp.MatchString(`^[a-z0-9-]{4,40}$`, options.Hostname); err != nil || !matched {
		return fmt.Errorf("Bad hostname: %s", options.Hostname)
	}

	srv := tsnet.Server{
		Dir:       options.StateDir,
		Hostname:  options.Hostname,
		Ephemeral: true,
		AuthKey:   options.AuthKey,
	}

	if err := srv.Start(); err != nil {
		return err
	}

	defer srv.Close()

	ln, err := srv.ListenTLS("tcp", ":443")

	if err = srv.Start(); err != nil {
		return err
	}

	for _, domain := range srv.CertDomains() {
		log.Printf("Listening as https://%s/", domain)
	}

	compress, err := httpcompression.DefaultAdapter()
	if err != nil {
		return err
	}

	proxy := httputil.ReverseProxy{
		Rewrite: func(r *httputil.ProxyRequest) {
			log.Printf("%s: %s %s", r.In.RemoteAddr, r.In.Method, r.In.URL.Path)
			r.SetXForwarded()
			r.SetURL(&url.URL{Scheme: "http", Host: options.Address})
		},
	}

	httpSrv := http.Server{
		Handler: compress(&proxy),
	}

	httpCloseErr := make(chan error, 1)
	go func() {
		defer close(httpCloseErr)
		<-ctx.Done()
		httpCloseErr <- httpSrv.Shutdown(context.Background())
	}()

	if err := httpSrv.Serve(ln); err != http.ErrServerClosed {
		return err
	}
	err = <-httpCloseErr
	return err
}

func generateXkcdPw() string {
	words := []string{
		XkcdDictionary[rand.Intn(len(XkcdDictionary))],
		XkcdDictionary[rand.Intn(len(XkcdDictionary))],
	}

	return strings.Join(words, "-")
}

var XkcdDictionary = []string{
	"able",
	"about",
	"above",
	"across",
	"action",
	"actually",
	"addition",
	"adjective",
	"advance",
	"afraid",
	"africa",
	"after",
	"again",
	"against",
	"agree",
	"agreed",
	"ahead",
	"airplane",
	"alabama",
	"alaska",
	"allow",
	"almost",
	"alone",
	"along",
	"already",
	"also",
	"although",
	"always",
	"america",
	"among",
	"amount",
	"amsterdam",
	"anger",
	"angle",
	"angry",
	"animal",
	"another",
	"answer",
	"anything",
	"appear",
	"apple",
	"appreciation",
	"april",
	"area",
	"arizona",
	"arms",
	"army",
	"around",
	"arrive",
	"arrived",
	"article",
	"asia",
	"athens",
	"attempt",
	"august",
	"aunt",
	"australia",
	"austria",
	"away",
	"baby",
	"back",
	"ball",
	"bank",
	"banker",
	"barbados",
	"base",
	"basket",
	"battle",
	"bean",
	"bear",
	"beat",
	"beautiful",
	"beauty",
	"became",
	"because",
	"become",
	"been",
	"before",
	"began",
	"begin",
	"behind",
	"being",
	"belfast",
	"belgium",
	"believe",
	"bell",
	"belong",
	"below",
	"berlin",
	"beside",
	"best",
	"better",
	"between",
	"beyond",
	"bicycle",
	"bill",
	"bird",
	"birds",
	"black",
	"block",
	"blood",
	"blow",
	"blue",
	"board",
	"boat",
	"body",
	"bone",
	"bones",
	"book",
	"born",
	"borrow",
	"both",
	"botswana",
	"bottle",
	"bottom",
	"branch",
	"branches",
	"brazil",
	"bread",
	"break",
	"bridge",
	"bright",
	"bring",
	"britain",
	"british",
	"broad",
	"broke",
	"broken",
	"brother",
	"brought",
	"brown",
	"build",
	"building",
	"built",
	"bulgaria",
	"burn",
	"burning",
	"business",
	"busy",
	"butter",
	"cake",
	"california",
	"call",
	"came",
	"canada",
	"cannot",
	"capital",
	"captain",
	"care",
	"carefully",
	"carry",
	"case",
	"catch",
	"cattle",
	"caught",
	"cause",
	"cells",
	"cent",
	"center",
	"cents",
	"century",
	"certain",
	"chair",
	"chance",
	"change",
	"character",
	"charge",
	"chart",
	"check",
	"chief",
	"child",
	"childhood",
	"children",
	"chile",
	"china",
	"choose",
	"church",
	"cigarette",
	"circle",
	"city",
	"class",
	"clean",
	"clear",
	"climbed",
	"clock",
	"close",
	"cloth",
	"clothes",
	"cloud",
	"coast",
	"coat",
	"cold",
	"college",
	"colombia",
	"color",
	"colour",
	"column",
	"come",
	"common",
	"company",
	"compare",
	"complete",
	"compound",
	"condition",
	"conditions",
	"congo",
	"consider",
	"considerable",
	"consonant",
	"contain",
	"continue",
	"continued",
	"control",
	"conversation",
	"cook",
	"cool",
	"copenhagen",
	"copy",
	"corn",
	"corner",
	"correct",
	"cost",
	"cotton",
	"could",
	"count",
	"counterpart",
	"country",
	"course",
	"cover",
	"covered",
	"cows",
	"create",
	"cried",
	"crops",
	"cross",
	"crowd",
	"cuba",
	"current",
	"daily",
	"damascus",
	"dance",
	"dare",
	"dark",
	"date",
	"daughter",
	"dead",
	"deal",
	"dear",
	"death",
	"december",
	"decide",
	"decided",
	"decimal",
	"deep",
	"degree",
	"delaware",
	"delight",
	"demand",
	"denmark",
	"describe",
	"desert",
	"design",
	"desire",
	"destroy",
	"details",
	"determine",
	"developed",
	"device",
	"dictionary",
	"died",
	"difference",
	"different",
	"difficult",
	"dinner",
	"direct",
	"direction",
	"disagreement",
	"discover",
	"discovered",
	"dish",
	"distance",
	"distant",
	"divide",
	"divided",
	"division",
	"doctor",
	"does",
	"dollar",
	"dollars",
	"done",
	"door",
	"double",
	"doubt",
	"down",
	"draw",
	"drawing",
	"dream",
	"dress",
	"dried",
	"drink",
	"drive",
	"drop",
	"dublin",
	"duck",
	"during",
	"dusk",
	"duty",
	"each",
	"early",
	"ears",
	"earth",
	"earth",
	"east",
	"easy",
	"edge",
	"effect",
	"effort",
	"eggs",
	"egypt",
	"eight",
	"either",
	"electric",
	"electricity",
	"elements",
	"else",
	"enemy",
	"energy",
	"engine",
	"england",
	"english",
	"enjoy",
	"enough",
	"enter",
	"entered",
	"entire",
	"equal",
	"equation",
	"escape",
	"especially",
	"etching",
	"europe",
	"even",
	"evening",
	"ever",
	"every",
	"everyone",
	"everything",
	"exactly",
	"example",
	"except",
	"exciting",
	"exercise",
	"expect",
	"experience",
	"experiment",
	"explain",
	"express",
	"face",
	"fact",
	"factories",
	"factors",
	"fail",
	"fair",
	"fall",
	"family",
	"famous",
	"fancy",
	"farm",
	"farmers",
	"fascinations",
	"fast",
	"father",
	"favor",
	"fear",
	"february",
	"feed",
	"feel",
	"feeling",
	"feet",
	"fell",
	"fellow",
	"felt",
	"fence",
	"field",
	"fifteen",
	"fifth",
	"fifty",
	"fight",
	"figure",
	"fiji",
	"fill",
	"filled",
	"finally",
	"find",
	"fine",
	"finger",
	"fingers",
	"finish",
	"finished",
	"finland",
	"fire",
	"firm",
	"first",
	"fish",
	"five",
	"flat",
	"flier",
	"floor",
	"florida",
	"flow",
	"flower",
	"flowers",
	"follow",
	"food",
	"fool",
	"foot",
	"force",
	"foreign",
	"forest",
	"forever",
	"forget",
	"form",
	"fortieth",
	"forty",
	"forward",
	"found",
	"four",
	"fraction",
	"france",
	"free",
	"french",
	"fresh",
	"friday",
	"friend",
	"friendliness",
	"friends",
	"from",
	"front",
	"fruit",
	"full",
	"fundamentally",
	"further",
	"future",
	"gain",
	"galaxy",
	"game",
	"garden",
	"gate",
	"gather",
	"gave",
	"general",
	"gentle",
	"gentleman",
	"germany",
	"gibraltar",
	"gift",
	"girl",
	"give",
	"gives",
	"glad",
	"glass",
	"glossary",
	"goes",
	"gold",
	"gone",
	"good",
	"goodbye",
	"govern",
	"government",
	"grain",
	"grass",
	"grave",
	"gray",
	"great",
	"greece",
	"greek",
	"green",
	"grew",
	"ground",
	"group",
	"grow",
	"grown",
	"guard",
	"guess",
	"guide",
	"hair",
	"half",
	"hall",
	"halt",
	"hand",
	"hang",
	"happen",
	"happened",
	"happy",
	"hard",
	"havana",
	"have",
	"hawaii",
	"head",
	"health",
	"hear",
	"heard",
	"heart",
	"heat",
	"heaven",
	"heavy",
	"height",
	"held",
	"hello",
	"help",
	"here",
	"hers",
	"high",
	"hill",
	"himself",
	"history",
	"hold",
	"hole",
	"holland",
	"home",
	"honor",
	"hope",
	"horse",
	"hour",
	"hours",
	"house",
	"however",
	"huge",
	"human",
	"hundred",
	"hunger",
	"hunt",
	"hunting",
	"hurry",
	"hurt",
	"husband",
	"iceland",
	"idea",
	"illustration",
	"important",
	"inch",
	"inches",
	"include",
	"increase",
	"indeed",
	"india",
	"indian",
	"indicate",
	"industry",
	"information",
	"insects",
	"inside",
	"instead",
	"instruments",
	"interest",
	"into",
	"ireland",
	"iron",
	"island",
	"italy",
	"itself",
	"jamaica",
	"japan",
	"japanese",
	"jerusalem",
	"join",
	"joined",
	"jordan",
	"journey",
	"judge",
	"july",
	"jump",
	"jumped",
	"june",
	"jupiter",
	"just",
	"keep",
	"kentucky",
	"kenya",
	"kept",
	"kill",
	"killed",
	"kind",
	"king",
	"kiss",
	"kitchen",
	"knew",
	"know",
	"known",
	"korea",
	"labor",
	"ladder",
	"lady",
	"lake",
	"land",
	"language",
	"large",
	"last",
	"late",
	"later",
	"laugh",
	"laughed",
	"laughter",
	"lead",
	"leader",
	"learn",
	"least",
	"leave",
	"left",
	"legs",
	"lend",
	"length",
	"less",
	"letter",
	"level",
	"liar",
	"life",
	"lift",
	"lifted",
	"light",
	"like",
	"likely",
	"line",
	"lisbon",
	"list",
	"listen",
	"little",
	"live",
	"located",
	"london",
	"lone",
	"long",
	"look",
	"lord",
	"lose",
	"loss",
	"lost",
	"loud",
	"love",
	"lower",
	"machine",
	"made",
	"madrid",
	"mail",
	"main",
	"major",
	"make",
	"malta",
	"manner",
	"many",
	"march",
	"march",
	"mark",
	"mark",
	"market",
	"marry",
	"mars",
	"maryland",
	"master",
	"match",
	"material",
	"matter",
	"maybe",
	"mayor",
	"mean",
	"measure",
	"meat",
	"meet",
	"meeting",
	"melody",
	"member",
	"members",
	"mercury",
	"metal",
	"method",
	"mexico",
	"middle",
	"middleweight",
	"might",
	"mile",
	"milk",
	"million",
	"mind",
	"mine",
	"minute",
	"minutes",
	"miss",
	"mister",
	"modern",
	"molecules",
	"moment",
	"monday",
	"money",
	"montana",
	"month",
	"months",
	"moon",
	"moon",
	"more",
	"morning",
	"moscow",
	"most",
	"mother",
	"mountain",
	"mouth",
	"move",
	"movement",
	"much",
	"music",
	"must",
	"nail",
	"name",
	"nation",
	"natural",
	"nature",
	"near",
	"nearly",
	"necessary",
	"neck",
	"need",
	"needle",
	"neighbor",
	"neither",
	"nepal",
	"neptune",
	"nerve",
	"netherlands",
	"nevada",
	"never",
	"news",
	"next",
	"nice",
	"niece",
	"night",
	"nine",
	"noise",
	"none",
	"noon",
	"north",
	"northern",
	"norway",
	"nose",
	"note",
	"nothing",
	"notice",
	"noun",
	"november",
	"number",
	"numeral",
	"object",
	"observe",
	"ocean",
	"october",
	"offer",
	"office",
	"often",
	"ohio",
	"once",
	"only",
	"open",
	"opinion",
	"opposite",
	"order",
	"orderly",
	"oslo",
	"other",
	"ought",
	"outer",
	"outside",
	"over",
	"oxygen",
	"page",
	"paid",
	"pain",
	"paint",
	"pair",
	"panama",
	"paper",
	"paragraph",
	"paris",
	"park",
	"part",
	"partial",
	"particular",
	"party",
	"pass",
	"passed",
	"past",
	"pattern",
	"peace",
	"people",
	"perfect",
	"perhaps",
	"period",
	"person",
	"peru",
	"phrase",
	"pick",
	"picked",
	"picture",
	"piece",
	"place",
	"plain",
	"plains",
	"plan",
	"plane",
	"planet",
	"plant",
	"plants",
	"play",
	"pleasant",
	"please",
	"pleasure",
	"plural",
	"pluto",
	"poem",
	"point",
	"poland",
	"pole",
	"poor",
	"portugal",
	"position",
	"possible",
	"pounds",
	"power",
	"practice",
	"prepare",
	"prepared",
	"present",
	"president",
	"presidents",
	"press",
	"pretty",
	"price",
	"printed",
	"probable",
	"probably",
	"problem",
	"process",
	"produce",
	"products",
	"promise",
	"property",
	"proud",
	"prove",
	"provide",
	"public",
	"pull",
	"pulled",
	"pure",
	"push",
	"pushed",
	"quarter",
	"queen",
	"question",
	"questions",
	"quick",
	"quickly",
	"quiet",
	"quite",
	"race",
	"radio",
	"rain",
	"raise",
	"raised",
	"rather",
	"reach",
	"reached",
	"read",
	"ready",
	"real",
	"realize",
	"really",
	"reason",
	"receive",
	"received",
	"record",
	"region",
	"remain",
	"remember",
	"repeated",
	"repercussion",
	"reply",
	"report",
	"represent",
	"require",
	"resent",
	"rest",
	"result",
	"return",
	"rhythm",
	"rich",
	"ridden",
	"ride",
	"right",
	"ring",
	"rise",
	"river",
	"road",
	"rock",
	"roll",
	"rolled",
	"rome",
	"room",
	"root",
	"rope",
	"rose",
	"round",
	"rule",
	"rush",
	"russia",
	"safe",
	"safety",
	"said",
	"sail",
	"salt",
	"same",
	"sand",
	"saturday",
	"saturn",
	"save",
	"says",
	"scale",
	"scene",
	"school",
	"science",
	"scientists",
	"score",
	"scotland",
	"season",
	"seat",
	"second",
	"section",
	"seed",
	"seeds",
	"seem",
	"seen",
	"self",
	"sell",
	"send",
	"sense",
	"sent",
	"sentence",
	"separate",
	"september",
	"serve",
	"service",
	"settle",
	"settled",
	"seven",
	"several",
	"shade",
	"shake",
	"shall",
	"shape",
	"share",
	"sharp",
	"shine",
	"ship",
	"shirt",
	"shoe",
	"shoes",
	"shop",
	"shore",
	"short",
	"shot",
	"should",
	"shoulder",
	"shout",
	"shouted",
	"show",
	"shown",
	"sick",
	"side",
	"sight",
	"sign",
	"signal",
	"silent",
	"silver",
	"similar",
	"simple",
	"since",
	"sing",
	"singapore",
	"single",
	"sister",
	"size",
	"skin",
	"sleep",
	"slept",
	"slow",
	"slowly",
	"small",
	"smell",
	"smiled",
	"smoke",
	"snow",
	"soft",
	"soil",
	"sold",
	"soldier",
	"soldiers",
	"solution",
	"some",
	"someone",
	"something",
	"sometimes",
	"song",
	"soon",
	"sorry",
	"sort",
	"sound",
	"south",
	"southern",
	"space",
	"spain",
	"speak",
	"special",
	"speed",
	"spell",
	"spend",
	"spent",
	"spoke",
	"spot",
	"spread",
	"spring",
	"square",
	"stand",
	"star",
	"stars",
	"start",
	"state",
	"statement",
	"station",
	"stay",
	"steel",
	"step",
	"stick",
	"still",
	"stock",
	"stone",
	"stood",
	"stop",
	"store",
	"storm",
	"story",
	"straight",
	"strange",
	"stranger",
	"stream",
	"street",
	"strength",
	"stretched",
	"strike",
	"string",
	"strong",
	"student",
	"students",
	"study",
	"subject",
	"substances",
	"succeed",
	"success",
	"such",
	"sudden",
	"suddenly",
	"suffer",
	"suffix",
	"sugar",
	"suggested",
	"suit",
	"summer",
	"sunday",
	"supply",
	"suppose",
	"sure",
	"surface",
	"surprise",
	"sweden",
	"sweet",
	"swim",
	"syllables",
	"symbols",
	"system",
	"table",
	"tail",
	"take",
	"taken",
	"talk",
	"tall",
	"taste",
	"teach",
	"teacher",
	"team",
	"tear",
	"tell",
	"temperature",
	"terms",
	"test",
	"texas",
	"than",
	"thank",
	"that",
	"their",
	"them",
	"themselves",
	"then",
	"there",
	"therefore",
	"these",
	"they",
	"thick",
	"thin",
	"thing",
	"think",
	"third",
	"thirteen",
	"this",
	"those",
	"though",
	"thought",
	"thousand",
	"thousands",
	"three",
	"threw",
	"through",
	"throw",
	"thrown",
	"thus",
	"tied",
	"till",
	"time",
	"tiny",
	"today",
	"together",
	"tokyo",
	"told",
	"tomorrow",
	"tone",
	"took",
	"tools",
	"tore",
	"total",
	"touch",
	"toward",
	"town",
	"track",
	"trade",
	"train",
	"training",
	"transmission",
	"travel",
	"tree",
	"triangle",
	"tried",
	"tries",
	"trip",
	"trouble",
	"truck",
	"true",
	"trust",
	"tube",
	"tuesday",
	"turn",
	"twelve",
	"twenty",
	"type",
	"uncle",
	"under",
	"underline",
	"understand",
	"understood",
	"unemployment",
	"unit",
	"until",
	"upon",
	"uranus",
	"usual",
	"usually",
	"valley",
	"value",
	"various",
	"venus",
	"verb",
	"vermont",
	"very",
	"view",
	"village",
	"virginia",
	"visit",
	"voice",
	"vowel",
	"wagon",
	"wait",
	"wales",
	"walk",
	"wall",
	"want",
	"wants",
	"warm",
	"warsaw",
	"wash",
	"washington",
	"watch",
	"water",
	"wave",
	"waves",
	"weak",
	"wear",
	"weather",
	"wedge",
	"wednesday",
	"week",
	"weight",
	"welcome",
	"well",
	"went",
	"were",
	"west",
	"western",
	"what",
	"wheat",
	"wheel",
	"wheels",
	"when",
	"where",
	"whether",
	"which",
	"while",
	"white",
	"whole",
	"whom",
	"whose",
	"wide",
	"wife",
	"wild",
	"will",
	"wind",
	"window",
	"wing",
	"wings",
	"winter",
	"wire",
	"wise",
	"wish",
	"with",
	"within",
	"without",
	"woman",
	"women",
	"wonder",
	"wood",
	"word",
	"wore",
	"work",
	"workers",
	"world",
	"worn",
	"worth",
	"would",
	"write",
	"written",
	"wrong",
	"wrote",
	"yard",
	"year",
	"yellow",
	"yesterday",
	"young",
	"your",
	"yourself",
}
